#!/usr/bin/env perl

# adapted from https://gist.github.com/dagolden/5171336
# 2013-03-15

my $as = shift
    or die "Usage: $0 <perl-version>";
my @args = @ARGV;
 
# trailing "t" means do threads
my @threads = ( $as =~ /t$/ ) ? (qw/-D usethreads/) : ();
 
$as =~ s/^5\.//;
my $perl = "5.$as";
$perl =~ s/t$//; # strip trailing "t" if any
my $lib = $as . '@std';

# TODO: these should all be in Task::BeLike::ETHER --
# which I should autogenerate by looking up all my dists and their develop
# prereqs
my @to_install = qw(
    App::Ack
    App::Nopaste
    App::cpanoutdated
    App::pmuninstall
    App::cpanminus::reporter
    Module::CoreList
    Unicode::Tussle
    Test::CPAN::Meta
    Test::Pod::Coverage
    Pod::Coverage::TrustPod
    Data::Dumper
    local::lib
    Archive::Tar::Wrapper
    LWP::Protocol::https
    ExtUtils::MakeMaker
    Module::Build::Tiny
    Test::Builder
    Devel::Confess
    Cpanel::JSON::XS
    YAML::Syck
    indirect multidimensional bareword::filehandles
    strictures
    Dist::Zilla::Plugin::Chrome::ExtraPrompt
    Dist::Zilla::Plugin::Bootstrap::lib
    Dist::Zilla::App::Command::dumpphases
    Dist::Zilla::App::Command::podpreview
    Module::Install
    Module::Install::Repository
    Module::Install::AuthorRequires
    Module::Install::ReadmeFromPod
    Module::Install::GithubMeta
    Module::Install::AutoLicense
    Dist::Zilla::PluginBundle::RJBS
    Dist::Zilla::PluginBundle::DAGOLDEN
    Dist::Zilla::PluginBundle::FLORA
);

# install with develop and recommended prereqs too
@to_install_with_everything  = qw(
    Dist::Zilla::PluginBundle::Author::ETHER
    Dist::Zilla
    Moose
);

my @no_man = qw/-D man1dir=none -D man3dir=none/;

#run( qw/perlbrew self-upgrade/ );
 
# install perl and lock it down

run( qw/perlbrew install -j 9 --as/, $as, $perl, @threads, @no_man, @args );
run( qw/chmod -R a-w/, "$ENV{HOME}/perl5/perlbrew/perls/$as" );

# give us a local::lib for installing things
run( qw/perlbrew lib create/, $lib );
 
## let's avoid any pod tests when we try to install stuff
#system( qw/perlbrew exec --with/, $lib, qw/cpanm TAP::Harness::Restricted/ );
#local $ENV{HARNESS_SUBCLASS} = "TAP::Harness::Restricted";
 
# some things need forcing
#if (@problem_modules)
#{
#    run( qw/perlbrew exec --with/, $lib, qw/cpanm -f/, @problem_modules )
#    run( qw/perlbrew exec --with/, $lib, qw/cpanm-reporter/);
#}
 
# now install the rest

# avoid my cpanm alias which invokes cpanm-reporter (in whatever perl is
# currently active)
chomp(my $cpanm = `which cpanm`);

# we need two passes for this -- https://github.com/miyagawa/cpanminus/issues/336
run( qw/perlbrew exec --with/, $lib, $cpanm, @to_install, @to_install_with_everything);
run( qw/perlbrew exec --with/, $lib, qw/cpanm-reporter/);
run( qw/perlbrew exec --with/, $lib, $cpanm, qw/--reinstall --installdeps --with-develop --with-recommends/, @to_install_with_everything );
run( qw/perlbrew exec --with/, $lib, qw/cpanm-reporter/);

# and again, to handle circular deps
print "\n\ninstalling again, to handle circular dependencies, and things that didn't install cleanly (WATCH FOR THESE!)...\n";
run( qw/perlbrew exec --with/, $lib, $cpanm, @to_install, @to_install_with_everything );
run( qw/perlbrew exec --with/, $lib, qw/cpanm-reporter/);

sub run
{
    my $cmd = join(' ', @_);
    print "Running: $cmd\n";
    system $cmd;
    die "$cmd returned exit code $?: stopping" if $?;
}

